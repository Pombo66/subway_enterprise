generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String       @id @default(cuid())
  email     String       @unique
  role      String       @default("STAFF")
  firstName String?
  lastName  String?
  active    Boolean      @default(true)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  Orders    Order[]
  StoreStaff StoreStaff[]
}

model Store {
  id                  String          @id @default(uuid())
  name                String
  address             String?
  postcode            String?
  country             String?
  region              String?
  city                String?
  status              String?
  ownerName           String?
  latitude            Float?
  longitude           Float?
  annualTurnover      Float?
  openedAt            DateTime?
  cityPopulationBand  String?
  isAISuggested       Boolean?        @default(false) // TRUE if saved from AI expansion suggestion
  operatingHours      String?         // JSON: { monday: { open: "09:00", close: "21:00" }, ... }
  phoneNumber         String?
  email               String?
  franchiseeId        String?
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  MenuItems           MenuItem[]
  Orders              Order[]
  PriceOverrides      PriceOverride[]
  Photos              StorePhoto[]
  Staff               StoreStaff[]
  Franchisee          Franchisee?     @relation(fields: [franchiseeId], references: [id])

  @@index([country])
  @@index([region])
  @@index([city])
  @@index([status])
  @@index([latitude, longitude])
  @@index([annualTurnover])
  @@index([postcode])
  @@index([isAISuggested])
  @@index([franchiseeId])
}

model StorePhoto {
  id        String   @id @default(cuid())
  storeId   String
  url       String
  caption   String?
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  Store     Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@index([storeId, sortOrder])
}

model StoreStaff {
  id         String   @id @default(cuid())
  storeId    String
  userId     String
  role       String   @default("STAFF") // MANAGER, STAFF
  assignedAt DateTime @default(now())
  Store      Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  User       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([storeId, userId])
  @@index([storeId])
  @@index([userId])
}

model MenuItem {
  id             String               @id @default(cuid())
  storeId        String
  name           String
  price          Decimal
  basePrice      Decimal?
  active         Boolean              @default(true)
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @default(now()) @updatedAt
  Store          Store                @relation(fields: [storeId], references: [id])
  modifiers      MenuItemModifier[]
  categories     MenuItemCategory[]
  PriceOverrides PriceOverride[]
  OrderItems     OrderItem[]

  @@index([storeId, active, createdAt])
  @@index([active, updatedAt])
  @@index([name])
  @@index([storeId, price])
}

model Order {
  id        String      @id @default(cuid())
  storeId   String
  userId    String?
  total     Decimal
  status    String      @default("PENDING")
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  User      User?       @relation(fields: [userId], references: [id])
  Store     Store       @relation(fields: [storeId], references: [id])
  items     OrderItem[]

  @@index([storeId, createdAt])
  @@index([status, createdAt])
  @@index([userId, createdAt])
  @@index([createdAt])
}

model OrderItem {
  id         String   @id @default(cuid())
  orderId    String
  menuItemId String
  quantity   Int
  price      Decimal
  subtotal   Decimal
  createdAt  DateTime @default(now())
  Order      Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  MenuItem   MenuItem @relation(fields: [menuItemId], references: [id])

  @@index([orderId])
  @@index([menuItemId])
}

model ModifierGroup {
  id           String             @id @default(cuid())
  name         String
  description  String?
  minSelection Int                @default(0)
  maxSelection Int?
  required     Boolean            @default(false)
  active       Boolean            @default(true)
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  menuItems    MenuItemModifier[]
  modifiers    Modifier[]

  @@index([active])
}

model MenuItemModifier {
  id              String        @id @default(cuid())
  menuItemId      String
  modifierGroupId String
  createdAt       DateTime      @default(now())
  modifierGroup   ModifierGroup @relation(fields: [modifierGroupId], references: [id], onDelete: Cascade)
  menuItem        MenuItem      @relation(fields: [menuItemId], references: [id], onDelete: Cascade)

  @@unique([menuItemId, modifierGroupId])
  @@index([menuItemId])
  @@index([modifierGroupId])
}

model FeatureFlag {
  id          String   @id @default(cuid())
  key         String   @unique
  enabled     Boolean  @default(false)
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([key])
  @@index([enabled])
}

model TelemetryEvent {
  id         String   @id @default(cuid())
  eventType  String
  userId     String?
  sessionId  String?
  properties String?
  timestamp  DateTime @default(now())

  @@index([eventType])
  @@index([timestamp])
  @@index([userId])
}

model Experiment {
  id          String    @id @default(cuid())
  name        String    @unique
  description String?
  status      String    @default("DRAFT")
  startDate   DateTime?
  endDate     DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([status])
  @@index([startDate])
}

model Category {
  id          String             @id @default(cuid())
  name        String
  description String?
  sortOrder   Int                @default(0)
  active      Boolean            @default(true)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  items       MenuItemCategory[]

  @@index([active, sortOrder])
}

model MenuItemCategory {
  id         String   @id @default(cuid())
  menuItemId String
  categoryId String
  createdAt  DateTime @default(now())
  menuItem   MenuItem @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([menuItemId, categoryId])
  @@index([menuItemId])
  @@index([categoryId])
}

model Modifier {
  id              String        @id @default(cuid())
  modifierGroupId String
  name            String
  priceAdjustment Decimal       @default(0)
  active          Boolean       @default(true)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  modifierGroup   ModifierGroup @relation(fields: [modifierGroupId], references: [id], onDelete: Cascade)

  @@index([modifierGroupId, active])
}

model PriceOverride {
  id            String    @id @default(cuid())
  storeId       String
  menuItemId    String
  price         Decimal
  effectiveFrom DateTime  @default(now())
  effectiveTo   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  store         Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  menuItem      MenuItem  @relation(fields: [menuItemId], references: [id], onDelete: Cascade)

  @@unique([storeId, menuItemId, effectiveFrom])
  @@index([storeId])
  @@index([menuItemId])
  @@index([effectiveFrom])
}

model AuditEntry {
  id        String   @id @default(cuid())
  actor     String
  entity    String
  entityId  String
  action    String
  diff      String?
  timestamp DateTime @default(now())

  @@index([entity, entityId])
  @@index([timestamp])
  @@index([actor])
}

model TradeArea {
  id                 String   @id @default(cuid())
  region             String
  country            String?
  scope              String   @default("legacy") // scope identifier
  scopeType          String   @default("region") // 'country', 'state', 'custom_area', 'region'
  customAreaPolygon  String?  // GeoJSON polygon for custom areas (JSON as string)
  centroidLat        Float
  centroidLng        Float
  population         Int
  footfallIndex      Float
  incomeIndex        Float
  competitorIdx      Float
  existingStoreDist  Float
  demandScore        Float
  supplyPenalty      Float
  competitionPenalty Float
  finalScore         Float
  confidence         Float
  dataMode           String   @default("live") // 'live' or 'modelled'
  modelVersion       String   @default("v0.1") // e.g. "v0.3"
  dataSnapshotDate   DateTime @default(now())
  cacheKey           String   @default("") // hash(scope, intensity, model_version, data_mode)
  isLive             Boolean  // kept for backward compatibility
  updatedAt          DateTime @updatedAt

  @@index([scope, scopeType, finalScore])
  @@index([cacheKey])
  @@index([dataMode, modelVersion])
  @@index([region, finalScore])
  @@index([confidence, isLive])
}

model ExpansionCache {
  id           String   @id @default(cuid())
  cacheKey     String   @unique
  scope        String   // ScopeSelection object as JSON string
  intensity    Int      // 0-100
  dataMode     String   // 'live' or 'modelled'
  modelVersion String
  suggestions  String   // cached ExpansionSuggestion[] as JSON string
  generatedAt  DateTime @default(now())
  expiresAt    DateTime

  @@index([cacheKey, expiresAt])
}

model ExpansionScenario {
  id                String                @id @default(uuid())
  label             String
  regionFilter      String                // JSON string: { country?: string, state?: string, boundingBox?: {...} }
  aggressionLevel   Int
  populationBias    Float
  proximityBias     Float
  turnoverBias      Float
  minDistanceM      Int
  seed              Int
  sourceDataVersion String
  createdBy         String
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  suggestions       ExpansionSuggestion[]

  @@index([createdBy, createdAt])
  @@index([regionFilter])
}

model ExpansionSuggestion {
  id                  String            @id @default(uuid())
  scenarioId          String
  lat                 Float
  lng                 Float
  confidence          Float
  rationale           String            // JSON string: { population: 0.72, proximityGap: 0.61, ... }
  rationaleText       String
  band                String
  status              String            @default("NEW")
  urbanDensityIndex   Float?
  roadDistanceM       Int?
  buildingDistanceM   Int?
  landuseType         String?
  mapboxValidated     Boolean           @default(false)
  aiRationaleCached   Boolean           @default(false)
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  scenario            ExpansionScenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)

  @@index([scenarioId, band])
  @@index([status])
  @@index([confidence])
}

model MapboxTilequeryCache {
  id                 String   @id @default(cuid())
  coordinateHash     String   @unique
  lat                Float
  lng                Float
  landuseType        String?
  roadDistanceM      Int?
  buildingDistanceM  Int?
  urbanDensityIndex  Float?
  isSuitable         Boolean
  rawResponse        String
  createdAt          DateTime @default(now())
  expiresAt          DateTime

  @@index([coordinateHash])
  @@index([expiresAt])
}

model OpenAIRationaleCache {
  id               String   @id @default(cuid())
  contextHash      String   @unique
  lat              Float
  lng              Float
  rationaleText    String
  factors          String?  // JSON: { population, proximity, turnover }
  confidence       Float?
  dataCompleteness Float?
  model            String?  // e.g., "gpt-4o-mini"
  temperature      Float?   // e.g., 0.2
  tokensUsed       Int
  createdAt        DateTime @default(now())
  expiresAt        DateTime

  @@index([contextHash])
  @@index([expiresAt])
}

model LandValidationCache {
  id               String   @id @default(cuid())
  coordinateHash   String   @unique
  lat              Float
  lng              Float
  isOnLand         Boolean
  distanceToCoastM Float?
  landPolygonId    String?
  rawResponse      String   // JSON response from Mapbox
  createdAt        DateTime @default(now())
  expiresAt        DateTime

  @@index([coordinateHash])
  @@index([expiresAt])
}

model SnappingCache {
  id              String   @id @default(cuid())
  coordinateHash  String   @unique
  originalLat     Float
  originalLng     Float
  snappedLat      Float?
  snappedLng      Float?
  snapTargetType  String?  // 'road' or 'building'
  snapDistanceM   Float?
  roadClass       String?  // e.g., 'primary', 'secondary', 'tertiary'
  buildingType    String?  // e.g., 'residential', 'commercial'
  rawResponse     String   // JSON response from Mapbox
  createdAt       DateTime @default(now())
  expiresAt       DateTime

  @@index([coordinateHash])
  @@index([expiresAt])
}

model DemographicCache {
  id                   String   @id @default(cuid())
  coordinateHash       String   @unique
  lat                  Float
  lng                  Float
  population           Int?
  populationGrowthRate Float?
  medianIncome         Float?
  nationalMedianIncome Float?
  incomeIndex          Float?
  areaClassification   String?  // 'urban', 'suburban', 'rural'
  dataSource           String   // 'csv', 'api', 'estimated'
  createdAt            DateTime @default(now())
  expiresAt            DateTime

  @@index([coordinateHash])
  @@index([expiresAt])
  @@index([areaClassification])
}

model OSMPOICache {
  id              String   @id @default(cuid())
  coordinateHash  String   @unique
  lat             Float
  lng             Float
  radius          Int
  poiType         String   // 'transport', 'education', 'retail', 'service'
  features        String   // JSON array of OSM features
  featureCount    Int
  createdAt       DateTime @default(now())
  expiresAt       DateTime

  @@index([coordinateHash, poiType])
  @@index([expiresAt])
  @@index([poiType])
}

model PerformanceCluster {
  id                String   @id @default(cuid())
  region            String   // For regional cluster analysis
  centroidLat       Float
  centroidLng       Float
  radius            Float
  storeIds          String   // JSON array of store IDs
  storeCount        Int
  averageTurnover   Float
  strength          Float
  demographics      String   // JSON cluster demographics
  anchorPatterns    String   // JSON array of common anchor types
  calculatedAt      DateTime @default(now())
  expiresAt         DateTime

  @@index([region])
  @@index([expiresAt])
  @@index([strength])
}

model StrategyScoringCache {
  id                String   @id @default(cuid())
  coordinateHash    String   @unique
  lat               Float
  lng               Float
  whiteSpaceScore   Float?
  economicScore     Float?
  anchorScore       Float?
  clusterScore      Float?
  strategyBreakdown String   // JSON detailed breakdown
  dominantStrategy  String?
  createdAt         DateTime @default(now())
  expiresAt         DateTime

  @@index([coordinateHash])
  @@index([expiresAt])
  @@index([dominantStrategy])
}

model OpenAIStrategyCache {
  id            String   @id @default(cuid())
  cacheKey      String   @unique
  responseData  String   // JSON: StrategyResponse object
  model         String   // e.g., "gpt-4"
  temperature   Float    // e.g., 0.3
  candidateCount Int     // Number of candidates analyzed
  tokensUsed    Int      // Total tokens consumed
  createdAt     DateTime @default(now())

  @@index([cacheKey])
  @@index([createdAt])
  @@index([model])
}

model AIContextAnalysisCache {
  id                   String   @id @default(cuid())
  contextHash          String   @unique
  lat                  Float
  lng                  Float
  marketAssessment     String
  competitiveAdvantages String  // JSON array
  riskFactors          String   // JSON array
  demographicInsights  String
  accessibilityAnalysis String
  uniqueSellingPoints  String   // JSON array
  confidenceScore      Float
  model                String?  // e.g., "gpt-4o-mini"
  temperature          Float?   // e.g., 0.3
  tokensUsed           Int      @default(0)
  createdAt            DateTime @default(now())
  expiresAt            DateTime

  @@index([contextHash])
  @@index([expiresAt])
  @@index([lat, lng])
}

model AIContextualInsightsCache {
  id                      String   @id @default(cuid())
  contextHash             String   @unique
  lat                     Float
  lng                     Float
  primaryStrengths        String   // JSON array
  marketOpportunities     String   // JSON array
  potentialChallenges     String   // JSON array
  recommendedPositioning  String
  seasonalConsiderations  String   // JSON array
  model                   String?  // e.g., "gpt-4o-mini"
  temperature             Float?   // e.g., 0.3
  tokensUsed              Int      @default(0)
  createdAt               DateTime @default(now())
  expiresAt               DateTime

  @@index([contextHash])
  @@index([expiresAt])
  @@index([lat, lng])
}

model AIRationaleDiversityCache {
  id                   String   @id @default(cuid())
  contextHash          String   @unique
  lat                  Float
  lng                  Float
  rationaleText        String
  keyFactors           String   // JSON: { population, proximity, turnover }
  uniquenessScore      Float
  contextualElements   String   // JSON array
  differentiators      String   // JSON array
  aiGeneratedInsights  String   // JSON array
  confidence           Float
  dataCompleteness     Float
  model                String?  // e.g., "gpt-4o-mini"
  temperature          Float?   // e.g., 0.2
  tokensUsed           Int      @default(0)
  createdAt            DateTime @default(now())
  expiresAt            DateTime

  @@index([contextHash])
  @@index([expiresAt])
  @@index([uniquenessScore])
  @@index([lat, lng])
}

model ExpansionJob {
  id                String   @id @default(cuid())
  idempotencyKey    String   @unique
  status            String   @default("queued") // queued, running, completed, failed
  userId            String
  params            String   // JSON: GenerationParams
  result            String?  // JSON: ExpansionResult
  error             String?  // Error message if failed
  tokenEstimate     Int?     // Estimated tokens before LLM call
  tokensUsed        Int?     // Actual tokens used
  costEstimate      Float?   // Estimated cost in currency units
  actualCost        Float?   // Actual cost charged
  startedAt         DateTime?
  completedAt       DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([idempotencyKey])
  @@index([status, createdAt])
  @@index([userId, createdAt])
}

model StoreAnalysisJob {
  id                String   @id @default(cuid())
  idempotencyKey    String   @unique
  status            String   @default("queued") // queued, processing, completed, failed
  userId            String
  params            String   // JSON: { region, storeIds?, analysisType }
  result            String?  // JSON: StoreAnalysisResult[]
  error             String?
  storesAnalyzed    Int?
  tokensUsed        Int?
  actualCost        Float?
  startedAt         DateTime?
  completedAt       DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([idempotencyKey])
  @@index([status, createdAt])
  @@index([userId, createdAt])
}

model StoreAnalysis {
  id                    String   @id @default(cuid())
  storeId               String
  analysisDate          DateTime @default(now())
  
  // Location Quality
  locationQualityScore  Int      // 0-100
  locationRating        String   // EXCELLENT, GOOD, FAIR, POOR
  locationStrengths     String   // JSON array
  locationWeaknesses    String   // JSON array
  
  // Performance Analysis
  expectedRevenue       Float?
  actualRevenue         Float?
  performanceGap        Float?   // actual - expected
  performanceGapPercent Float?   // (actual - expected) / expected * 100
  
  // Root Cause
  primaryFactor         String   // LOCATION, FRANCHISEE, MARKET, BALANCED
  
  // Franchisee Analysis
  franchiseeRating      String?  // EXCELLENT, GOOD, FAIR, POOR
  franchiseeStrengths   String?  // JSON array
  franchiseeConcerns    String?  // JSON array
  
  // Recommendations
  recommendationPriority String  // HIGH, MEDIUM, LOW
  recommendations       String   // JSON array
  estimatedImpact       Float?   // potential revenue increase
  
  // AI Metadata
  model                 String   // gpt-5, gpt-5-mini
  tokensUsed            Int?
  analysisVersion       String   @default("1.0")
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([storeId, analysisDate])
  @@index([locationQualityScore])
  @@index([primaryFactor])
  @@index([recommendationPriority])
}

model IntelligenceDemographicCache {
  id              String   @id @default(cuid())
  lat             Float
  lng             Float
  radius          Int
  demographicData String   // JSON: DemographicProfile object
  dataSource      String   // 'census', 'commercial', 'ai_inferred'
  confidence      Float    // 0-1 data confidence
  createdAt       DateTime @default(now())
  expiresAt       DateTime

  @@index([lat, lng, radius])
  @@index([expiresAt])
  @@index([dataSource])
}

// ============================================
// REVENUE FORECASTING MODELS
// ============================================

model RevenueForecast {
  id                String   @id @default(cuid())
  storeId           String
  
  // Forecast period
  forecastDate      DateTime
  forecastMonth     Int      // 1-12
  forecastYear      Int
  
  // Predictions
  predictedRevenue  Float
  confidenceLow     Float    // 80% confidence interval lower bound
  confidenceHigh    Float    // 80% confidence interval upper bound
  
  // Components (for explainability)
  baselineRevenue   Float
  seasonalFactor    Float    // Multiplier (1.0 = average)
  trendFactor       Float    // Growth/decline factor
  
  // Metadata
  modelVersion      String   @default("1.0")
  generatedAt       DateTime @default(now())
  
  @@unique([storeId, forecastDate])
  @@index([storeId])
  @@index([forecastDate])
  @@index([forecastYear, forecastMonth])
}

model SeasonalPattern {
  id                String   @id @default(cuid())
  storeId           String
  
  // Pattern details
  month             Int      // 1-12
  dayOfWeek         Int?     // 0-6 (optional, for future daily patterns)
  
  // Factors
  seasonalIndex     Float    // Multiplier (1.0 = average, 1.2 = 20% above average)
  confidence        Float    // 0-1 confidence in pattern
  
  // Analysis metadata
  detectedAt        DateTime @default(now())
  sampleSize        Int      // Number of data points used
  
  @@unique([storeId, month])
  @@index([storeId])
  @@index([month])
}

model ForecastJob {
  id                String   @id @default(cuid())
  
  // Scope
  storeId           String?  // null = all stores
  region            String?
  country           String?
  
  // Configuration
  horizonMonths     Int      @default(12)
  includeConfidence Boolean  @default(true)
  regenerate        Boolean  @default(false) // Force regeneration
  
  // Status
  status            String   @default("queued") // queued, running, completed, failed
  progress          Int      @default(0)       // 0-100
  
  // Results
  storesProcessed   Int      @default(0)
  forecastsGenerated Int     @default(0)
  
  // Timing
  createdAt         DateTime @default(now())
  startedAt         DateTime?
  completedAt       DateTime?
  
  // Error handling
  error             String?
  
  // AI metadata
  tokensUsed        Int?
  aiExplanations    Int      @default(0)
  
  @@index([status])
  @@index([createdAt])
  @@index([storeId])
}

// ============================================
// COMPETITIVE INTELLIGENCE MODELS
// ============================================

model CompetitorPlace {
  id                String   @id @default(cuid())
  
  // Identity
  brand             String   // e.g., "McDonald's", "KFC", "Burger King"
  name              String   // e.g., "McDonald's Downtown"
  category          String   // e.g., "qsr", "coffee", "pizza"
  
  // Location
  latitude          Float
  longitude         Float
  address           String?
  city              String?
  country           String?
  postcode          String?
  
  // Data Sources
  googlePlaceId     String?  @unique
  osmId             String?
  sources           String   // JSON array: ["google", "osm", "manual"]
  
  // Metadata
  firstSeen         DateTime @default(now())
  lastVerified      DateTime @default(now())
  lastUpdated       DateTime @updatedAt
  
  // Data Quality
  reliabilityScore  Float    @default(1.0) // 0-1 confidence in data
  isActive          Boolean  @default(true)
  
  // Additional Info
  phoneNumber       String?
  website           String?
  rating            Float?
  reviewCount       Int?
  priceLevel        Int?     // 1-4
  
  // Competitive Analysis
  threatLevel       String?  // LOW, MEDIUM, HIGH
  marketShare       Float?   // Estimated local market share
  
  @@index([brand, category])
  @@index([latitude, longitude])
  @@index([country, city])
  @@index([isActive])
  @@index([lastVerified])
}

model CompetitorRefreshJob {
  id                String   @id @default(cuid())
  
  // Scope
  region            String?
  country           String?
  boundingBox       String?  // JSON: { north, south, east, west }
  
  // Configuration
  sources           String   // JSON: ["google", "osm"]
  categories        String   // JSON: ["qsr", "coffee", "pizza"]
  
  // Status
  status            String   @default("queued") // queued, running, completed, failed
  progress          Int      @default(0)        // 0-100
  
  // Results
  placesFound       Int      @default(0)
  placesAdded       Int      @default(0)
  placesUpdated     Int      @default(0)
  placesDeactivated Int      @default(0)
  
  // Timing
  createdAt         DateTime @default(now())
  startedAt         DateTime?
  completedAt       DateTime?
  
  // Error handling
  error             String?
  
  // API usage
  googleApiCalls    Int      @default(0)
  osmApiCalls       Int      @default(0)
  
  @@index([status])
  @@index([createdAt])
}

model CompetitiveAnalysis {
  id                    String   @id @default(cuid())
  
  // Scope
  storeId               String?  // If analyzing for specific store
  region                String?  // If analyzing region
  latitude              Float?
  longitude             Float?
  radiusKm              Float?
  
  // Analysis Results
  analysisDate          DateTime @default(now())
  
  // Competitor Counts
  totalCompetitors      Int
  competitorsByBrand    String   // JSON: { "McDonald's": 5, "KFC": 3, ... }
  competitorsByCategory String   // JSON: { "qsr": 8, "coffee": 4, ... }
  
  // Competitive Metrics
  marketSaturation      Float    // 0-100
  competitivePressure   Float    // 0-100
  threatLevel           String   // LOW, MEDIUM, HIGH, EXTREME
  
  // Nearest Competitors
  nearestCompetitor     String?  // Brand name
  nearestDistance       Float?   // km
  
  // Market Share Estimates
  estimatedMarketShare  Float?   // 0-100
  dominantCompetitor    String?
  
  // AI Insights
  aiSummary             String?
  strategicRecommendations String? // JSON array
  
  // Metadata
  model                 String?  @default("gpt-5.1")
  tokensUsed            Int?
  
  @@index([storeId])
  @@index([region])
  @@index([analysisDate])
  @@index([threatLevel])
}

// ============================================
// FRANCHISEE INTELLIGENCE MODELS
// ============================================

model Franchisee {
  id                String   @id @default(cuid())
  
  // Identity
  name              String
  email             String?
  phone             String?
  
  // Business info
  companyName       String?
  taxId             String?
  
  // Experience
  joinedDate        DateTime
  yearsExperience   Int?
  previousIndustry  String?
  
  // Performance
  totalStores       Int      @default(0)
  activeStores      Int      @default(0)
  avgStoreRevenue   Float?
  totalRevenue      Float?
  
  // Scores
  performanceScore  Float?   // 0-100
  expansionScore    Float?   // 0-100 (readiness for more stores)
  riskScore         Float?   // 0-100 (churn risk)
  
  // Status
  status            String   @default("ACTIVE") // ACTIVE, PROBATION, EXITED
  
  // Metadata
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  stores            Store[]
  analyses          FranchiseeAnalysis[]
  
  @@index([performanceScore])
  @@index([expansionScore])
  @@index([status])
  @@index([totalStores])
}

model FranchiseeAnalysis {
  id                    String     @id @default(cuid())
  franchiseeId          String
  franchisee            Franchisee @relation(fields: [franchiseeId], references: [id])
  
  // Analysis date
  analysisDate          DateTime   @default(now())
  
  // Performance metrics
  avgRevenuePerStore    Float
  revenueGrowthRate     Float
  profitabilityIndex    Float
  
  // Operational metrics
  avgStoreAge           Float      // months
  storeOpeningRate      Float      // stores per year
  storeClosureRate      Float
  
  // Quality metrics
  customerSatisfaction  Float?
  operationalCompliance Float?
  brandStandards        Float?
  
  // Benchmarking
  peerRanking           Int?       // 1-100 percentile
  industryRanking       Int?
  
  // Expansion readiness
  expansionReady        Boolean    @default(false)
  recommendedStores     Int?       // How many more stores they can handle
  expansionRationale    String?
  
  // Risk factors
  churnRisk             String     // LOW, MEDIUM, HIGH
  riskFactors           String     // JSON array
  
  // AI insights
  aiSummary             String?
  recommendations       String     // JSON array
  
  // Metadata
  model                 String     @default("gpt-5-mini")
  tokensUsed            Int?
  
  @@index([franchiseeId, analysisDate])
  @@index([expansionReady])
  @@index([churnRisk])
}
